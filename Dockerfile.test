# Test Runner Docker Image
# Runs pytest tests against the browser-pool service

FROM python:3.11-slim-bullseye

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV PYTHONIOENCODING=UTF-8

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create app directory
WORKDIR /app

# Install test dependencies (try uv first, fallback to pip)
RUN for i in 1 2 3; do \
      curl -LsSf https://astral.sh/uv/install.sh -o /tmp/uv-install.sh && \
      sh /tmp/uv-install.sh && \
      /root/.local/bin/uv pip install --system --no-cache \
        pytest>=8.0.0 \
        pytest-timeout>=2.3.0 \
        pytest-xdist>=3.5.0 \
        pytest-order>=1.2.0 \
        pytest-rerunfailures>=12.0 \
        requests>=2.31.0 \
        pydantic>=2.0.0 \
        urllib3>=2.0.0 \
        lazy-imports>=0.3.0 \
        python-dateutil>=2.8.0 && \
      exit 0 || { \
        echo "uv attempt $i failed, retrying in 15s..."; \
        sleep 15; \
      }; \
    done; \
    echo "uv failed, falling back to pip..."; \
    pip install --no-cache-dir \
      pytest>=8.0.0 \
      pytest-timeout>=2.3.0 \
      pytest-xdist>=3.5.0 \
      pytest-order>=1.2.0 \
      pytest-rerunfailures>=12.0 \
      requests>=2.31.0 \
      pydantic>=2.0.0 \
      urllib3>=2.0.0 \
      lazy-imports>=0.3.0 \
      python-dateutil>=2.8.0
ENV PATH="/root/.local/bin:$PATH"

# Add paths for imports
ENV PYTHONPATH="/app/generated-clients/python:/app/src:$PYTHONPATH"

# Default test results directory
RUN mkdir -p /app/test-results

# pytest.ini and test-entrypoint.sh are mounted via docker-compose
ENTRYPOINT ["/test-entrypoint.sh"]
