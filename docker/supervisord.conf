[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
silent=false

# Note: Xvfb and Fluxbox are now started directly in entrypoint.sh
# This provides better control over startup order and error handling

# Browser service runs separately from Flask to avoid context issues
[program:browser-service]
command=python -m airbrowser.server.ipc.service
directory=/app
user=browseruser
autostart=true
autorestart=true
priority=100
stdout_logfile=/var/log/supervisor/browser-service.log
stderr_logfile=/var/log/supervisor/browser-service.log
environment=DISPLAY=":99",PYTHONPATH="/app/src:$PYTHONPATH",PYTHONUNBUFFERED="1",HOME="/home/browseruser",MAX_BROWSERS="%(ENV_MAX_BROWSERS)s"
stopwaitsecs=30

[program:flask-api]
command=python -m airbrowser.server.app
directory=/app
user=browseruser
autostart=true
autorestart=true
priority=300
stdout_logfile=/var/log/supervisor/flask-api.log
stderr_logfile=/var/log/supervisor/flask-api.log
environment=DISPLAY=":99",PYTHONPATH="/app/src:$PYTHONPATH",PYTHONUNBUFFERED="1",HOME="/home/browseruser",ENABLE_MCP="%(ENV_ENABLE_MCP)s"
stopwaitsecs=30

# Log forwarder - tails service logs to stdout for docker compose logs visibility
[program:log-forwarder]
command=tail -F /var/log/supervisor/browser-service.log /var/log/supervisor/flask-api.log /tmp/browser-launcher-logs/*.log
directory=/app
autostart=true
autorestart=true
priority=999
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
redirect_stderr=true

# MCP server is now integrated into Flask API when ENABLE_MCP=true
# The separate MCP server process is no longer needed

# nginx is started directly in entrypoint.sh to avoid supervisor conflicts
# [program:nginx]
# command=nginx -g "daemon off;"
# user=root
# autostart=true
# autorestart=true
# priority=400
# stdout_logfile=/var/log/supervisor/nginx.log
# stderr_logfile=/var/log/supervisor/nginx_error.log
# stopwaitsecs=30
